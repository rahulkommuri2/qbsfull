<template>
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
    </template>
    <template if:true={errorMessage}>
        <div class="slds-notification slds-notification_toast slds-theme_error">
            <div class="slds-notification__body">
                <lightning-icon icon-name="utility:error" variant="inverse" size="small" class="slds-m-right_small"></lightning-icon>
                {errorMessage}
            </div>
        </div>
    </template>
    <template if:false={isLoading}>
        <lightning-layout multiple-rows class="slds-m-top_x-small">
            <lightning-layout-item size="12">
                <div class="">
                    <div class="slds-p-horizontal_medium slds-p-bottom_medium">
                        <lightning-layout multiple-rows>
                            <lightning-layout-item size="12" class="slds-m-bottom_small">
                                <template if:true={isMobileView}>
                                    <lightning-layout horizontal-align="spread">
                                        <lightning-layout-item size="12">
                                            <lightning-button
                                                icon-name="utility:back"
                                                label="Back"
                                                variant="base"
                                                class="slds-m-right_x-small"
                                                onclick={navigateToTrainings}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </template>
                                <template if:false={isMobileView}>
                                    <lightning-button
                                        icon-name="utility:back"
                                        label="Back to Trainings"
                                        variant="base"
                                        class="slds-m-right_x-small"
                                        onclick={navigateToTrainings}
                                    ></lightning-button>
                                </template>
                            </lightning-layout-item>
                            <lightning-layout-item size="12" large-device-size="4" class="slds-p-around_small">
                                <h2 class="slds-text-heading_medium slds-m-bottom_x-small">
                                    New Training
                                </h2>
                                <div class="slds-text-body_small slds-text-color_weak">
                                    For assistance, review our guide for entering new trainings.
                                </div>
                            </lightning-layout-item>
                        </lightning-layout>
                    </div>
                    <div class="slds-p-horizontal_medium">
                        <lightning-layout multiple-rows>
                            <!--Training Details-->
                            <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Training Details</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-combobox
                                            label="Sub Organization"
                                            value={selectedSubOrganization}
                                            options={subOrganizationOptions}
                                            onchange={updateSubOrganization}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                        <lightning-combobox
                                            label="Certification Type"
                                            value={selectedCertificationType}
                                            options={certificationTypeOptions}
                                            onchange={updateCertificationType}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                        <lightning-layout multiple-rows="false" class="slds-m-bottom_small">
                                            <lightning-layout-item size="6" class="slds-p-right_small">
                                                <lightning-input
                                                    type="date"
                                                    label="Start Date"
                                                    value={trainingStartDate}
                                                    onchange={updateStartDate}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="6" class="slds-p-left_small">
                                                <lightning-input
                                                    type="date"
                                                    label="End Date"
                                                    value={trainingEndDate}
                                                    onchange={updateEndDate}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                        <lightning-combobox
                                            label="Authorization"
                                            value={selectedAuthorization}
                                            options={authorizationOptions}
                                            onchange={updateAuthorization}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!--Location Details-->
                            <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Location Details</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-input
                                            label="Training Location Address"
                                            value={trainingLocationAddress}
                                            onchange={updateLocationAddress}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-input>
                                        <lightning-layout multiple-rows="false" class="slds-m-bottom_small">
                                            <lightning-layout-item size="6" class="slds-p-right_small">
                                                <lightning-input
                                                    label="City"
                                                    value={locationCity}
                                                    onchange={updateCity}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="6" class="slds-p-left_small">
                                                <lightning-combobox
                                                    label="State/Province"
                                                    value={selectedState}
                                                    options={stateOptions}
                                                    onchange={updateState}
                                                    disabled={editingDisabled}
                                                ></lightning-combobox>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                        <lightning-input
                                            label="Zip/Postal Code"
                                            value={locationZipCode}
                                            onchange={updateZipCode}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-input>
                                        <lightning-textarea
                                            label="Training Note"
                                            value={trainingNotes}
                                            placeholder="For internal use only - Not for contacting QBS"
                                            onchange={updateTrainingNotes}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!--Trainers-->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Trainers</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-layout multiple-rows>
                                            <lightning-layout-item size="12" medium-device-size="6" class="slds-p-horizontal_xx-small">
                                                <lightning-combobox
                                                    data-id="primaryFaculty"
                                                    label="Primary Faculty"
                                                    value={primaryFacultyContactId}
                                                    options={trainerOptions}
                                                    onchange={updatePrimaryFaculty}
                                                    disabled={editingDisabled}
                                                >
                                                    <template slot="suffix">
                                                        <lightning-button-icon
                                                            icon-name="utility:close"
                                                            variant="bare"
                                                            size="small"
                                                            onclick={clearPrimaryFaculty}
                                                            disabled={editingDisabled}
                                                            alternative-text="Clear selection"
                                                            class="slds-input__icon"
                                                        ></lightning-button-icon>
                                                    </template>
                                                </lightning-combobox>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" medium-device-size="6" class="slds-p-horizontal_xx-small">
                                                <lightning-combobox
                                                    data-id="secondaryFaculty"
                                                    label="Secondary Faculty"
                                                    value={secondaryFacultyContactId}
                                                    options={secondaryTrainerOptions}
                                                    onchange={updateSecondaryFaculty}
                                                    disabled={secondaryFacultyDisabled}
                                                >
                                                    <template slot="suffix">
                                                        <lightning-button-icon
                                                            icon-name="utility:close"
                                                            variant="bare"
                                                            size="small"
                                                            onclick={clearSecondaryFaculty}
                                                            disabled={secondaryFacultyDisabled}
                                                            alternative-text="Clear selection"
                                                            class="slds-input__icon"
                                                        ></lightning-button-icon>
                                                    </template>
                                                </lightning-combobox>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!--Courses-->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Courses</h3>
                                    <lightning-layout multiple-rows>
                                        <lightning-layout-item size="12" large-device-size="5" class="slds-p-around_small">
                                            <lightning-radio-group
                                                name="courseSelection"
                                                label="Select Courses"
                                                options={courseOptions}
                                                value={selectedCourseType}
                                                onchange={updateCourseSelection}
                                                disabled={editingDisabled}
                                                class="slds-p-around_small"
                                            ></lightning-radio-group>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="12" large-device-size="7" class="slds-p-around_small">
                                            <template if:true={hasCourseCompetencies}>
                                                <div style="height: 30vh;" class="slds-scrollable_y">
                                                    <lightning-datatable
                                                        key-field="Id"
                                                        data={courseData}
                                                        columns={courseColumns}
                                                        hide-checkbox-column
                                                        class="slds-table_bordered"
                                                    ></lightning-datatable>
                                                </div>
                                                <div>
                                                    <lightning-input
                                                        label="Time"
                                                        value={courseDuration}
                                                        onchange={updateCourseDuration}
                                                        disabled={editingDisabled}
                                                    ></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={hasCourseCompetencies}>
                                                <div class="slds-illustration slds-illustration_small">
                                                    <div class="slds-text-align_center slds-p-around_medium">
                                                        <lightning-icon icon-name="utility:knowledge_base" size="large" class="slds-text-color_weak"></lightning-icon>
                                                        <h3 class="slds-text-heading_small slds-m-top_small">No courses available</h3>
                                                        <p class="slds-text-color_weak">Please select a course type to view available competencies</p>
                                                    </div>
                                                </div>
                                            </template>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </div>
                            </lightning-layout-item>
                            <!--Specialists-->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <lightning-layout horizontal-align="spread" class="slds-border_bottom slds-m-bottom_small">
                                        <lightning-layout-item size="5">
                                            <h2 class="slds-text-heading_small">Specialists</h2>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="7" class="slds-text-align_right">
                                            <template if:true={isMobileView}>
                                                    <lightning-button
                                                        label="Add New Specialist"
                                                        variant="base"
                                                        icon-name="utility:adduser"
                                                        onclick={addNewSpecialist}
                                                        disabled={editingDisabled}
                                                        class=""
                                                    ></lightning-button>
                                            </template>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                    
                                    <div class="slds-p-top_medium">
                                        
                                        <lightning-layout multiple-rows="false" horizontal-align="spread" class="slds-m-bottom_medium">
                                            <lightning-layout-item size="12" medium-device-size="6" large-device-size="5" class="slds-p-right_small">
                                                <lightning-combobox
                                                    data-id="specialist"
                                                    label="Add Specialist"
                                                    placeholder="Search for a Specialist to add"
                                                    value={selectedSpecialistContactId}
                                                    options={specialistOptions}
                                                    onchange={updateSpecialistSelection}
                                                    disabled={editingDisabled}
                                                    spinner-active={isSpecialistLoading}
                                                >                                                   
                                                </lightning-combobox>
                                            </lightning-layout-item>
                                            <template if:false={isMobileView}>
                                                <lightning-layout-item size="12" medium-device-size="3" large-device-size="3" class="slds-m-top_large slds-text-align_right">
                                                    <lightning-button
                                                        label="Add New Specialist"
                                                        variant="neutral"
                                                        icon-name="utility:adduser"
                                                        onclick={addNewSpecialist}
                                                        disabled={editingDisabled}
                                                        class="slds-m-top_small"
                                                    ></lightning-button>
                                                </lightning-layout-item>
                                            </template>
                                            
                                        </lightning-layout>
                                        <template if:true={hasSpecialistsAssigned}>
                                            <div class="specialist-table-container">
                                                <div class="slds-scrollable_x">
                                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                                        <thead>
                                                            <tr class="slds-line-height_reset">
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Name</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Organization</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Email Address</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">ID/Department</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Grade</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Actions</div>
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <template for:each={specialists} for:item="specialist">
                                                                <tr key={specialist.contactId} class="slds-hint-parent">
                                                                    <td data-label="Name">
                                                                        <div class="slds-truncate specialist-name">
                                                                            <lightning-icon icon-name="standard:contact" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                            {specialist.name}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Organization">
                                                                        <div class="slds-truncate">
                                                                            {specialist.accountName}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Email">
                                                                        <div class="slds-truncate">
                                                                            <template if:true={specialist.specialistEmail}>
                                                                                <a href={specialist.emailLink} class="email-link">
                                                                                    {specialist.specialistEmail}
                                                                                </a>
                                                                            </template>
                                                                            <template if:false={specialist.specialistEmail}>
                                                                                <span class="slds-text-color_weak">No email</span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="ID/Department">
                                                                        <div class="slds-truncate">
                                                                            {specialist.department}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Grade">
                                                                        <div class="slds-truncate">
                                                                            <template if:true={specialist.grade}>
                                                                                <lightning-badge label={specialist.grade} class="grade-badge"></lightning-badge>
                                                                            </template>
                                                                            <template if:false={specialist.grade}>
                                                                                <span class="slds-text-color_weak">Not graded</span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Actions">
                                                                        <lightning-button-icon
                                                                            icon-name="utility:delete"
                                                                            variant="bare"
                                                                            alternative-text="Remove specialist"
                                                                            title="Remove specialist"
                                                                            size="small"
                                                                            data-specialist-id={specialist.contactId}
                                                                            onclick={removeSpecialist}
                                                                            disabled={editingDisabled}
                                                                        ></lightning-button-icon>
                                                                    </td>
                                                                </tr>
                                                            </template>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </template>
                                        <template if:false={hasSpecialistsAssigned}>
                                            <div class="slds-illustration slds-illustration_small">
                                                <div class="slds-text-align_center slds-p-around_medium">
                                                    <lightning-icon icon-name="utility:groups" size="large" class="slds-text-color_weak"></lightning-icon>
                                                    <h3 class="slds-text-heading_small slds-m-top_small">No specialists added</h3>
                                                    <p class="slds-text-color_weak">Add specialists to this training session</p>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!--Actions-->
                            <lightning-layout-item size="12">
                                <div class="slds-card__footer">
                                    <lightning-layout horizontal-align="spread" vertical-align="center" multiple-rows>
                                        <lightning-layout-item size="12" large-device-size="12">
                                            <template if:true={isMobileView}>
                                                <lightning-layout horizontal-align="center" vertical-align="center" multiple-rows>
                                                    <lightning-layout-item class="slds-p-around_xx-small" size="12">
                                                        <lightning-button
                                                            label="Save"
                                                            variant="brand"
                                                            stretch
                                                            icon-name="utility:save"
                                                            onclick={saveTraining}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                    <lightning-layout-item class="slds-p-around_xx-small" size="12">
                                                        <lightning-button
                                                            label="Grade & Finalize"
                                                            variant="brand"
                                                            stretch
                                                            icon-name="utility:check"
                                                            onclick={gradeAndFinalize}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                </lightning-layout>
                                            </template>
                                            <template if:false={isMobileView}>
                                                <lightning-layout horizontal-align="end">
                                                    <lightning-layout-item class="slds-p-horizontal_xx-small">
                                                        <lightning-button
                                                            label="Save"
                                                            variant="brand"
                                                            icon-name="utility:save"
                                                            onclick={saveTraining}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                    <lightning-layout-item class="slds-p-horizontal_xx-small">
                                                        <lightning-button
                                                            label="Grade & Finalize"
                                                            variant="brand"
                                                            icon-name="utility:check"
                                                            onclick={gradeAndFinalize}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                </lightning-layout>
                                            </template>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </div>
                            </lightning-layout-item>
                        </lightning-layout>
                    </div>
                </div>
            </lightning-layout-item>
        </lightning-layout>
    </template>