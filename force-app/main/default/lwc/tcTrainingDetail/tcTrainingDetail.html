<template>
    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
    </template>
    <!-- Error Message -->
    <template if:true={errorMessage}>
        <div class="slds-notification slds-notification_toast slds-theme_error">
            <div class="slds-notification__body">
                <lightning-icon icon-name="utility:error" variant="inverse" size="small" class="slds-m-right_small"></lightning-icon>
                {errorMessage}
            </div>
        </div>
    </template>
    <!-- Main Content -->
    <template if:false={isLoading}>
        <lightning-layout multiple-rows class="slds-m-top_x-small">
            <lightning-layout-item size="12">
                <div>
                    <!-- Header Section -->
                    <div class="slds-p-horizontal_medium slds-p-bottom_medium">
                        <lightning-layout multiple-rows>
                            <lightning-layout-item size="12" class="slds-m-bottom_small">
                                <template if:true={isMobileView}>
                                    <lightning-layout horizontal-align="spread">
                                        <lightning-layout-item size="5">
                                            <lightning-button
                                                icon-name="utility:back"
                                                label="Back"
                                                variant="base"
                                                class="slds-m-right_x-small"
                                                onclick={navigateToTrainings}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="2"></lightning-layout-item>
                                        <lightning-layout-item size="5" class="slds-text-align_right">
                                            <lightning-button
                                                variant="base"
                                                icon-name={mobileMenuIcon}
                                                icon-position="right"
                                                alternative-text="Toggle Menu"
                                                label="Menu"
                                                title="Toggle Menu"
                                                onclick={toggleMobileMenu}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                    <template if:true={isMobileMenuVisible}>
                                        <lightning-layout class="slds-m-top_small slds-box slds-p-around_small" multiple-rows horizontal-align="center">
                                            <lightning-layout-item size="12" class="slds-p-around_xx-small">
                                                <lightning-button
                                                    variant="neutral"
                                                    icon-name="utility:edit"
                                                    label="Edit Training"
                                                    stretch
                                                    onclick={editTraining}
                                                ></lightning-button>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" class="slds-p-around_xx-small">
                                                <lightning-button
                                                    variant="neutral"
                                                    icon-name="utility:refresh"
                                                    label="Refinalize"
                                                    stretch
                                                    onclick={refinalizeTraining}
                                                ></lightning-button>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" class="slds-p-around_xx-small">
                                                <lightning-button
                                                    variant="neutral"
                                                    icon-name="utility:download"
                                                    label="Download Certificates"
                                                    stretch
                                                    onclick={downloadCertificates}
                                                ></lightning-button>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" class="slds-p-around_xx-small">
                                                <lightning-button
                                                    variant="neutral"
                                                    icon-name="utility:email"
                                                    label="Email Certificates"
                                                    stretch
                                                    onclick={emailCertificates}
                                                ></lightning-button>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" class="slds-p-around_xx-small">
                                                <lightning-button
                                                    variant="neutral"
                                                    icon-name="utility:replace"
                                                    label="Request Correction"
                                                    stretch
                                                    onclick={requestCorrection}
                                                ></lightning-button>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </template>
                                </template>
                                <template if:false={isMobileView}>
                                    <lightning-button
                                        icon-name="utility:back"
                                        label="Back to Trainings"
                                        variant="base"
                                        class="slds-m-right_x-small"
                                        onclick={navigateToTrainings}
                                    ></lightning-button>
                                </template>
                            </lightning-layout-item>
                            <lightning-layout-item size="12" large-device-size="4" class="slds-p-around_small">
                                <h2 class="slds-text-heading_medium slds-m-bottom_x-small">
                                    Training Details
                                </h2>
                                <div class="slds-text-body_small slds-text-color_weak">
                                    For assistance, review our guide for entering new trainings.
                                </div>
                            </lightning-layout-item>
                            <template if:false={isMobileView}>
                                <lightning-layout-item size="12" large-device-size="8" class="slds-p-around_small">
                                    <lightning-layout horizontal-align="end" pull-to-boundary="small">
                                        <lightning-layout-item class="slds-p-horizontal_xx-small">
                                            <lightning-button
                                                variant="brand"
                                                label="Edit Training"
                                                icon-name="utility:edit"
                                                onclick={editTraining}
                                                disabled={isNotEditable}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item class="slds-p-horizontal_xx-small">
                                            <lightning-button
                                                variant="brand"
                                                label="Refinalize"
                                                icon-name="utility:refresh"
                                                onclick={refinalizeTraining}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item class="slds-p-horizontal_xx-small">
                                            <lightning-button
                                                variant="brand"
                                                label="Download Certificates"
                                                icon-name="utility:download"
                                                onclick={downloadCertificates}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item class="slds-p-horizontal_xx-small">
                                            <lightning-button
                                                variant="brand"
                                                label="Email Certificates"
                                                icon-name="utility:email"
                                                onclick={emailCertificates}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                        <lightning-layout-item class="slds-p-horizontal_xx-small">
                                            <lightning-button
                                                variant="brand"
                                                label="Request Correction"
                                                icon-name="utility:replace"
                                                onclick={requestCorrection}
                                            ></lightning-button>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </lightning-layout-item>
                            </template>
                        </lightning-layout>
                    </div>
                    <!-- Body Section -->
                    <div class="slds-p-horizontal_medium">
                        <lightning-layout multiple-rows>
                            <!-- Training Details Section -->
                            <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Training Details</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-combobox
                                            label="Sub Organization"
                                            value={selectedSubOrganization}
                                            options={subOrganizationOptions}
                                            onchange={updateSubOrganization}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                        <lightning-combobox
                                            label="Certification Type"
                                            value={selectedCertificationType}
                                            options={certificationTypeOptions}
                                            onchange={updateCertificationType}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                        <lightning-layout multiple-rows="false" class="slds-m-bottom_small">
                                            <lightning-layout-item size="6" class="slds-p-right_small">
                                                <lightning-input
                                                    type="date"
                                                    label="Start Date"
                                                    value={trainingStartDate}
                                                    onchange={updateStartDate}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="6" class="slds-p-left_small">
                                                <lightning-input
                                                    type="date"
                                                    label="End Date"
                                                    value={trainingEndDate}
                                                    onchange={updateEndDate}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                        <lightning-combobox
                                            label="Authorization"
                                            value={selectedAuthorization}
                                            options={authorizationOptions}
                                            onchange={updateAuthorization}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-combobox>
                                        <div class="slds-box slds-m-top_small slds-theme_shade">
                                            <lightning-layout multiple-rows="false">
                                                <lightning-layout-item size="6" class="slds-p-right_small">
                                                    <div class="slds-align_absolute-center">
                                                        <span class="slds-text-body_regular">Actual Time: <span class="slds-text-heading_small slds-text-color_success"><strong>{formattedActualTrainingTime}</strong></span></span>
                                                    </div>
                                                </lightning-layout-item>
                                                <lightning-layout-item size="6" class="slds-p-left_small">
                                                    <div class="slds-align_absolute-center">
                                                        <span class="slds-text-body_regular">Minimum Time: <span class="slds-text-heading_small slds-text-color_weak"><strong>{formattedMinimumTrainingTime}</strong></span></span>
                                                    </div>
                                                </lightning-layout-item>
                                            </lightning-layout>
                                        </div>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!-- Location Details Section -->
                            <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Location Details</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-input
                                            label="Training Location Address"
                                            value={trainingLocationAddress}
                                            onchange={updateLocationAddress}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-input>
                                        <lightning-layout multiple-rows="false" class="slds-m-bottom_small">
                                            <lightning-layout-item size="6" class="slds-p-right_small">
                                                <lightning-input
                                                    label="City"
                                                    value={locationCity}
                                                    onchange={updateCity}
                                                    disabled={editingDisabled}
                                                ></lightning-input>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="6" class="slds-p-left_small">
                                                <lightning-combobox
                                                    label="State/Province"
                                                    value={selectedState}
                                                    options={stateOptions}
                                                    onchange={updateState}
                                                    disabled={editingDisabled}
                                                ></lightning-combobox>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                        <lightning-input
                                            label="Zip/Postal Code"
                                            value={locationZipCode}
                                            onchange={updateZipCode}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-input>
                                        <lightning-textarea
                                            label="Training Note"
                                            value={trainingNotes}
                                            placeholder="For internal use only - Not for contacting QBS"
                                            onchange={updateTrainingNotes}
                                            disabled={editingDisabled}
                                            class="slds-m-bottom_small"
                                        ></lightning-textarea>
                                        <lightning-combobox
                                            label="Finalized"
                                            value={finalizedStatus}
                                            options={finalizedStatusOptions}
                                            onchange={updateFinalizedStatus}
                                            disabled={editingDisabled}
                                        ></lightning-combobox>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!-- Trainers Section -->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Trainers</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-layout multiple-rows>
                                            <lightning-layout-item size="12" medium-device-size="6" class="slds-p-horizontal_xx-small">
                                                <lightning-record-picker
                                                    label="Primary Faculty"
                                                    value={primaryFacultyContactId}
                                                    object-api-name="Contact"
                                                    filter={primaryFacultyFilterCriteria}
                                                    onchange={updatePrimaryFaculty}
                                                    disabled={editingDisabled}
                                                ></lightning-record-picker>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" medium-device-size="6" class="slds-p-horizontal_xx-small">
                                                <lightning-record-picker
                                                    label="Secondary Faculty"
                                                    value={secondaryFacultyContactId}
                                                    object-api-name="Contact"
                                                    filter={secondaryFacultyFilterCriteria}
                                                    onchange={updateSecondaryFaculty}
                                                    disabled={editingDisabled}
                                                ></lightning-record-picker>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!-- Courses Section -->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Courses</h3>
                                    <lightning-layout multiple-rows>
                                        <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                            <lightning-radio-group
                                                name="courseSelection"
                                                label="Select Courses"
                                                options={courseOptions}
                                                value={selectedCourseId}
                                                onchange={updateCourseSelection}
                                                disabled={editingDisabled}
                                                class="slds-p-around_small"
                                            ></lightning-radio-group>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                            <template if:true={hasCourseCompetencies}>
                                                <div style="height: 30vh;" class="slds-scrollable_y slds-box">
                                                    <lightning-datatable
                                                        key-field="id"
                                                        data={trainingCourseList}
                                                        columns={courseColumns}
                                                        hide-checkbox-column
                                                    ></lightning-datatable>
                                                </div>
                                                <div>
                                                    <lightning-input
                                                        label="Time"
                                                        value={courseDuration}
                                                        onchange={updateCourseDuration}
                                                        disabled={editingDisabled}
                                                    ></lightning-input>
                                                </div>
                                            </template>
                                            <template if:false={hasCourseCompetencies}>
                                                <div class="slds-illustration slds-illustration_small">
                                                    <div class="slds-text-align_center slds-p-around_medium">
                                                        <lightning-icon icon-name="utility:knowledge_base" size="large" class="slds-text-color_weak"></lightning-icon>
                                                        <h3 class="slds-text-heading_small slds-m-top_small">No courses available</h3>
                                                        <p class="slds-text-color_weak">Please select a course type to view available competencies</p>
                                                    </div>
                                                </div>
                                            </template>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </div>
                            </lightning-layout-item>
                            <!-- Specialists Section -->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-theme_default">
                                    <h3 class="slds-text-heading_small slds-border_bottom slds-p-bottom_small">Specialists</h3>
                                    <div class="slds-p-top_medium">
                                        <lightning-layout multiple-rows="false" horizontal-align="spread" class="slds-m-bottom_medium">
                                            <lightning-layout-item size="8" medium-device-size="6" large-device-size="4" class="slds-p-right_small">
                                                <lightning-record-picker
                                                    label="Add Specialist"
                                                    object-api-name="Contact"
                                                    placeholder="Search for a Specialist to add"
                                                    value={selectedSpecialistContactId}
                                                    onchange={updateSpecialistSelection}
                                                    disabled={editingDisabled}
                                                ></lightning-record-picker>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="4" medium-device-size="3" large-device-size="5" class="slds-m-top_medium slds-text-align_left">
                                                <lightning-button
                                                    label="Add"
                                                    title="Add Specialist to Training"
                                                    icon-name="utility:add"
                                                    variant="neutral"
                                                    onclick={addSpecialist}
                                                    disabled={addSpecialistDisabled}
                                                    class="slds-text-align_left slds-m-top_small"
                                                ></lightning-button>
                                            </lightning-layout-item>
                                            <lightning-layout-item size="12" medium-device-size="3" large-device-size="3" class="slds-m-top_medium slds-text-align_center">
                                                <lightning-button
                                                    label="Add New Specialist"
                                                    variant="brand"
                                                    icon-name="utility:adduser"
                                                    onclick={addNewSpecialist}
                                                    disabled={editingDisabled}
                                                    class="slds-m-top_small"
                                                ></lightning-button>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                        <template if:true={hasSpecialistsAssigned}>
                                            <div class="specialist-table-container">
                                                <div class="slds-scrollable_x">
                                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                                        <thead>
                                                            <tr class="slds-line-height_reset">
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">ID/Department</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Name</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Email Address</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Organization</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Grade</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Restrictions</div>
                                                                </th>
                                                                <th class="slds-text-title_caps table-header" scope="col">
                                                                    <div class="slds-truncate">Actions</div>
                                                                </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <template for:each={specialistList} for:item="specialist">
                                                                <tr key={specialist.conId} class="slds-hint-parent">
                                                                    <td data-label="ID/Department">
                                                                        <div class="slds-truncate">
                                                                            {specialist.certificationName}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Name">
                                                                        <div class="slds-truncate specialist-name">
                                                                            <lightning-icon icon-name="standard:contact" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                            {specialist.name}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Email">
                                                                        <div class="slds-truncate">
                                                                            <template if:true={specialist.specialistEmail}>
                                                                                <a href={specialist.emailLink} class="email-link">
                                                                                    {specialist.specialistEmail}
                                                                                </a>
                                                                            </template>
                                                                            <template if:false={specialist.specialistEmail}>
                                                                                <span class="slds-text-color_weak">No email</span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Organization">
                                                                        <div class="slds-truncate">
                                                                            {specialist.accountId}
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Grade">
                                                                        <div class="slds-truncate">
                                                                            <template if:true={specialist.grade}>
                                                                                <lightning-badge label={specialist.grade} class="grade-badge"></lightning-badge>
                                                                            </template>
                                                                            <template if:false={specialist.grade}>
                                                                                <span class="slds-text-color_weak">Not graded</span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Restrictions">
                                                                        <div class="slds-truncate">
                                                                            <template if:true={specialist.restrictions}>
                                                                                <span class="slds-text-color_error restriction-text">
                                                                                    <lightning-icon icon-name="utility:warning" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                                    {specialist.restrictions}
                                                                                </span>
                                                                            </template>
                                                                            <template if:false={specialist.restrictions}>
                                                                                <span class="slds-text-color_success">
                                                                                    <lightning-icon icon-name="utility:success" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                                                    No restrictions
                                                                                </span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                    <td data-label="Actions">
                                                                        <lightning-button-icon
                                                                            icon-name="utility:delete"
                                                                            variant="bare"
                                                                            alternative-text="Remove specialist"
                                                                            title="Remove specialist"
                                                                            size="small"
                                                                            data-specialist-id={specialist.conId}
                                                                            onclick={removeSpecialist}
                                                                            disabled={editingDisabled}
                                                                        ></lightning-button-icon>
                                                                    </td>
                                                                </tr>
                                                            </template>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </template>
                                        <template if:false={hasSpecialistsAssigned}>
                                            <div class="slds-illustration slds-illustration_small">
                                                <div class="slds-text-align_center slds-p-around_medium">
                                                    <lightning-icon icon-name="utility:groups" size="large" class="slds-text-color_weak"></lightning-icon>
                                                    <h3 class="slds-text-heading_small slds-m-top_small">No specialists added</h3>
                                                    <p class="slds-text-color_weak">Add specialists to this training session</p>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </lightning-layout-item>
                            <!-- Action Buttons Section -->
                            <lightning-layout-item size="12" class="slds-p-around_small">
                                <div class="slds-card__footer">
                                    <lightning-layout horizontal-align="spread" vertical-align="center" multiple-rows>
                                        <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                            <div class="slds-text-color_weak slds-text-body_small slds-text-align_left">
                                                <template if:true={editingDisabled}>
                                                    <lightning-icon icon-name="utility:lock" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                    Editing is disabled for this training
                                                </template>
                                                <template if:false={editingDisabled}>
                                                    <lightning-icon icon-name="utility:edit" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                    Training is editable
                                                </template>
                                            </div>
                                        </lightning-layout-item>
                                        <lightning-layout-item size="12" large-device-size="6" class="slds-p-around_small">
                                            <template if:true={isMobileView}>
                                                <lightning-layout horizontal-align="center" vertical-align="center" multiple-rows>
                                                    <lightning-layout-item class="slds-p-around_xx-small" size="12">
                                                        <lightning-button
                                                            label="Save"
                                                            variant="brand"
                                                            stretch
                                                            icon-name="utility:save"
                                                            onclick={saveTraining}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                    <lightning-layout-item class="slds-p-around_xx-small" size="12">
                                                        <lightning-button
                                                            label="Grade & Finalize"
                                                            variant="brand"
                                                            stretch
                                                            icon-name="utility:check"
                                                            onclick={gradeAndFinalize}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                </lightning-layout>
                                            </template>
                                            <template if:false={isMobileView}>
                                                <lightning-layout horizontal-align="end">
                                                    <lightning-layout-item class="slds-p-horizontal_xx-small">
                                                        <lightning-button
                                                            label="Save"
                                                            variant="brand"
                                                            icon-name="utility:save"
                                                            onclick={saveTraining}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                    <lightning-layout-item class="slds-p-horizontal_xx-small">
                                                        <lightning-button
                                                            label="Grade & Finalize"
                                                            variant="brand"
                                                            icon-name="utility:check"
                                                            onclick={gradeAndFinalize}
                                                            disabled={editingDisabled}
                                                        ></lightning-button>
                                                    </lightning-layout-item>
                                                </lightning-layout>
                                            </template>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                </div>
                            </lightning-layout-item>
                        </lightning-layout>
                    </div>
                </div>
            </lightning-layout-item>
        </lightning-layout>
    </template>
</template>